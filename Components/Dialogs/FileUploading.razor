@using Ongaku.Interfaces
@inject ISnackbar Snackbar
@inject Ongaku.Services.TrackService TrackService

<style>
    .file-upload-input {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 10;
        opacity: 0;
    }
</style>

<MudDialog>
	<TitleContent>File uploading</TitleContent>
	<DialogContent>
        <MudStack Style="width: 100%">
            <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                           @ref="@_fileUpload"
                           OnFilesChanged="OnInputFileChanged"
                           AppendMultipleFiles
                           Hidden="@false"
                           InputClass="file-upload-input"
                           tabindex="-1"
                           MaximumFileCount="100"
                           @ondrop="@ClearDragClass"
                           @ondragenter="@SetDragClass"
                           @ondragleave="@ClearDragClass"
                           @ondragend="@ClearDragClass"
                           @ondragover:preventDefault="true"
                           Accept=".mp3, .wav, .aac">
                <ActivatorContent>
                    <MudPaper Height="300px"
                              Outlined="true"
                              Class="@_dragClass">
                        <MudText Typo="Typo.h6">
                            Drag and drop files here or click
                        </MudText>
                        @foreach (var file in _fileNames)
                        {
                            <MudChip T="string"
                                     Color="Color.Dark"
                                     Text="@file"
                                     tabindex="-1" />
                        }
                    </MudPaper>
                </ActivatorContent>
            </MudFileUpload>
        </MudStack>
	</DialogContent>
	<DialogActions>
        <MudToolBar Gutters="@false"
                    Class="relative d-flex justify-end gap-4">
            <MudButton Color="Color.Secondary"
                       Disabled="@(!_fileNames.Any() || _proccessing)"
                       OnClick="@Upload"
                       Variant="Variant.Filled">
                @if (_proccessing)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate />
                    <MudText Class="ms-2">Proccessing</MudText>
                }
                else
                {
                    <MudText>Upload</MudText>
                }
            </MudButton>
            <MudButton Color="Color.Error"
                       Disabled="@(!_fileNames.Any())"
                       OnClick="@ClearAsync"
                       Variant="Variant.Filled">
                Clear
            </MudButton>
        </MudToolBar>
	</DialogActions>
</MudDialog>


@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

#nullable enable
    private const string DefaultDragClass = "relative rounded-lg border-2 border-dashed pa-4 mt-4 mud-width-full mud-height-full";
    private string _dragClass = DefaultDragClass;
    private readonly List<string> _fileNames = new();
    private readonly List<IBrowserFile> _files = new();
    private MudFileUpload<IReadOnlyList<IBrowserFile>>? _fileUpload;
    private static readonly string[] AllowedExtensions = { ".mp3", ".wav", ".aac" };
    private bool _proccessing = false;

    private async Task ClearAsync()
    {
        await (_fileUpload?.ClearAsync() ?? Task.CompletedTask);
        _fileNames.Clear();
        _files.Clear();
        ClearDragClass();
    }

    private Task OpenFilePickerAsync()
        => _fileUpload?.OpenFilePickerAsync() ?? Task.CompletedTask;

    private void OnInputFileChanged(InputFileChangeEventArgs e)
    {
        ClearDragClass();
        var files = e.GetMultipleFiles();
        foreach (var file in files)
        {
            var ext = Path.GetExtension(file.Name).ToLowerInvariant();

            if (!AllowedExtensions.Contains(ext))
            {
                Snackbar.Add($"Extension of file '{file.Name}' not supported!", Severity.Error);
                continue;
            }

            _fileNames.Add(file.Name);
            _files.Add(file);
        }
    }

    private async Task Upload()
    {
        try {
            _proccessing = true;

            if (_fileUpload == null || !_files.Any())
            {
                return;
            }

            foreach (var file in _files)
            {
                await using var readStream = file.OpenReadStream(200_000_000_000);
                await using var ms = new MemoryStream();

                await readStream.CopyToAsync(ms);
                ms.Position = 0;

                await TrackService.AddTrackAsync(file.Name, ms);
            }

            _proccessing = false;

            MudDialog!.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка: {ex.Message}", Severity.Error);
        }
    }

    private void SetDragClass()
        => _dragClass = $"{DefaultDragClass} mud-border-secondary";

    private void ClearDragClass()
        => _dragClass = DefaultDragClass;
}
